<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munger</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="quotes.js"></script>
    
    <!-- DataTables CSS èµ„æº -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; }
        h1 { color: #1e88e5; }
        
        .loading { text-align: center; color: #555; padding: 20px; font-style: italic; }
        .success { color: #4caf50; font-weight: bold; margin-top: 10px; }
        .error { color: #e53935; font-weight: bold; margin-top: 10px; }
        
        /* è¯­å½•æ¡†æ ·å¼ */
        .quote-container { 
            background-color: #fff9c4; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 20px auto; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            max-width: 800px; 
        }
        .quote-text { 
            font-size: 18px; 
            font-style: italic; 
            color: #856404; 
            margin-bottom: 10px; 
            line-height: 1.6; 
        }
        .quote-author { 
            font-size: 15px;
            text-align: right; 
            font-weight: bold; 
            color: #b83838; 
        }
        
        /* è¡¨å¤´æ ·å¼ */
        #munger-table thead th {
            background-color: #2196F3 !important;
            color: white !important;
            font-weight: bold;
            text-align: center;
            border-bottom: 2px solid #1976D2;
            border-right: 1px solid rgba(255,255,255,0.3);
        }
        #munger-table thead th:last-child {
            border-right: none;
        }
        
        /* åˆ·æ–°çŠ¶æ€æç¤ºæ ·å¼ */
        .refresh-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>

    <h1>ğŸ“ Munger è¡¨æ ¼æ•°æ® (åªè¯»)</h1>
    
    <!-- åˆ·æ–°çŠ¶æ€æç¤º -->
    <div id="refresh-status" class="refresh-status"></div>
    
    <!-- è¯­å½•æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="quote-container">
        <div id="quote-text" class="quote-text">æ­£åœ¨åŠ è½½è¯­å½•...</div>
        <div id="quote-author" class="quote-author"></div>
    </div>

    <!-- DataTables å®¹å™¨ -->
    <div id="data-container">
        <div class="loading">æ­£åœ¨è¿æ¥ Supabase å¹¶åŠ è½½æ•°æ®...</div>
    </div>
    
    <p id="message-status"></p>

   <script>
        // =======================================================================
        // ã€é…ç½®ä¿¡æ¯ã€‘
        // =======================================================================
        const SUPABASE_URL = 'https://qburustwmcjpnilofjsi.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFidXJ1c3R3bWNqcG5pbG9manNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MTI4MjUsImV4cCI6MjA3OTM4ODgyNX0.mzJN1k0ogNnr9kpqtandH_OH9nHIIeNrde1uac4JEdc'; 
        const TABLE_NAME = 'Munger'; 
        
        // å®šæ—¶åˆ·æ–°é…ç½® (æ”¹ä¸ºç»Ÿä¸€æ£€æŸ¥é—´éš”ï¼Œç®€åŒ–é€»è¾‘)
        // æ ¸å¿ƒï¼šè®¾ç½®ä¸€ä¸ªåŸºç¡€çš„æ£€æŸ¥é—´éš”ï¼Œè®©å®ƒæ¥å†³å®šæ˜¯å¦è¦åˆ·æ–°
        const BASE_CHECK_INTERVAL = 60000; // 1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        const REFRESH_INTERVAL = 600000; // 10åˆ†é’Ÿåˆ·æ–°é—´éš” (ä¸å˜ï¼Œç”¨äºæ—¶é—´å¯¹æ¯”)

        // è¯­å½•æ›´æ–°é…ç½®
        const QUOTE_UPDATE_INTERVAL = 300000; // 5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡è¯­å½•
        

        // =======================================================================
        
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const dataContainer = document.getElementById('data-container');
        const statusMessage = document.getElementById('message-status');
        const quoteTextElement = document.getElementById('quote-text');
        const quoteAuthorElement = document.getElementById('quote-author');
        const refreshStatusElement = document.getElementById('refresh-status');
        
        // DataTables å®ä¾‹
        let dataTableInstance = null;
        // æ–°å¢ï¼šç”¨äºè®°å½•ä¸Šæ¬¡åˆ·æ–°æ—¶é—´
        let lastRefreshTime = 0; 

        // ä»quotesDataä¸­éšæœºè¯»å–å¹¶æ˜¾ç¤ºè¯­å½•çš„å‡½æ•°
        function loadRandomQuote() {
            try {
                // æ£€æŸ¥quotesDataæ˜¯å¦å­˜åœ¨ä¸”æ˜¯æ•°ç»„
                if (!window.quotesData || !Array.isArray(window.quotesData) || window.quotesData.length === 0) {
                    quoteTextElement.textContent = 'æ— æ³•åŠ è½½è¯­å½•æ•°æ®';
                    quoteAuthorElement.textContent = '';
                    console.warn('quotesDataä¸å¯ç”¨æˆ–ä¸ºç©º');
                    return;
                }
                
                // éšæœºé€‰æ‹©ä¸€æ¡è¯­å½•
                const randomIndex = Math.floor(Math.random() * window.quotesData.length);
                const selectedQuote = window.quotesData[randomIndex];
                
                // æ›´æ–°DOMå…ƒç´ 
                if (selectedQuote && selectedQuote.quote) {
                    quoteTextElement.textContent = selectedQuote.quote;
                    quoteAuthorElement.textContent = selectedQuote.author ? `- ${selectedQuote.author}` : '';
                } else {
                    quoteTextElement.textContent = 'è¯­å½•æ ¼å¼ä¸æ­£ç¡®';
                    quoteAuthorElement.textContent = '';
                }
            } catch (error) {
                console.error('åŠ è½½è¯­å½•æ—¶å‡ºé”™:', error);
                quoteTextElement.textContent = 'åŠ è½½è¯­å½•æ—¶å‡ºé”™';
                quoteAuthorElement.textContent = '';
            }
        }

        // çŠ¶æ€æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'error' : 'success';
            setTimeout(() => statusMessage.textContent = '', 3000);
        }

        // åˆ·æ–°çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
        function showRefreshStatus(message, isError = false) {
            refreshStatusElement.textContent = message;
            refreshStatusElement.style.display = 'block';
            refreshStatusElement.style.background = isError ? 'rgba(229, 57, 53, 0.8)' : 'rgba(0, 0, 0, 0.7)';
            
            setTimeout(() => {
                refreshStatusElement.style.display = 'none';
            }, 3000);
        }

        // --- æ•°æ®æ ¼å¼åŒ–è¾…åŠ©å‡½æ•° ---
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            try {
                // ç›´æ¥æå–å¹´æœˆæ—¥-æ—¶åˆ†ç§’éƒ¨åˆ†
                return isoString.replace('T', ' ').split('.')[0];
            } catch (e) { return isoString; }
        }
        function formatPrice(value) {
            if (value === null || isNaN(value)) return '-';
            return parseFloat(value).toFixed(2);
        }
        function formatRatio(value) {
            if (value === null || isNaN(value)) return '-';
            return (parseFloat(value) * 100).toFixed(2) + '%';
        }

        // -----------------------------------------------------------------------
        // å‡½æ•°ï¼šä» Supabase è¯»å–æ•°æ®å¹¶åˆå§‹åŒ– DataTables
        // -----------------------------------------------------------------------
        async function fetchAndDisplayData() {
            dataContainer.innerHTML = '<div class="loading">æ­£åœ¨ä» Supabase è¯»å–æ•°æ®...</div>';
            
            try {
                const { data: rows, error } = await client
                    .from(TABLE_NAME)
                    .select('*')
                    .order('ratio', { ascending: true }); 

                if (error) {
                    showErrorState(`æ•°æ®åŠ è½½å¤±è´¥ï¼é”™è¯¯ä¿¡æ¯ï¼š${error.message}`, 'è¯»å–æ•°æ®å¤±è´¥');
                    return;
                }

                if (!rows || rows.length === 0) {
                    dataContainer.innerHTML = '<p class="loading">æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°æ•°æ®ã€‚</p>';
                    return;
                }

                createDataTable(rows);
                showStatus('æ•°æ®åŠ è½½æˆåŠŸ');
                
            } catch (e) {
                console.error('JS è¿è¡Œæ—¶é”™è¯¯:', e);
                showErrorState('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ã€‚', 'é¡µé¢åˆå§‹åŒ–å¤±è´¥');
            }
        }

        function showErrorState(message, statusText) {
            dataContainer.innerHTML = `<p class="error">${message}</p>`;
            showStatus(statusText, true);
        }

        function createDataTable(data) {
            // æ¸…ç†æ—§å®ä¾‹
            if (dataTableInstance) {
                dataTableInstance.destroy();
            }
            
            dataContainer.innerHTML = '<table id="munger-table" class="display" style="width:100%"><thead><tr><th>Name</th><th>Code</th><th>Target Price</th><th>Current Price</th><th>Ratio</th><th>Note</th><th>Updated At</th></tr></thead></table>';
            dataTableInstance = $('#munger-table').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/zh.json'
                },
                data: data,
                columns: getTableColumns(),
                order: [[4, 'asc']],
                searching: false,
                paging: false,
                lengthChange: false,
                info: true,
                responsive: true,
                dom: 'rtip'
            });
        }

        function getTableColumns() {
            return [
                { data: 'name', title: 'åç§°' },
                { data: 'code', title: 'ä»£ç ' },
                { 
                    data: 'target_price', 
                    title: 'ç›®æ ‡ä»·',
                    render: (data, type) => type === 'display' ? formatPrice(data) : data
                },
                { 
                    data: 'current_price', 
                    title: 'ç°ä»·',
                    render: (data, type) => type === 'display' ? formatPrice(data) : data
                },
                { 
                    data: 'ratio', 
                    title: 'æ¯”ä¾‹',
                    render: (data, type) => {
                        if (type === 'display') {
                            const formattedValue = formatRatio(data);
                            const ratioValue = parseFloat(data) * 100;
                            return ratioValue <= 5 ? 
                                `<span style="color: #4caf50; font-weight: bold;">${formattedValue}</span>` : 
                                formattedValue;
                        }
                        return data;
                    }
                },
                { data: 'note', title: 'å¤‡æ³¨' },
                { 
                    data: 'updated_at', 
                    title: 'æ›´æ–°æ—¶é—´',
                    render: (data, type) => type === 'display' ? formatDateTime(data) : data,
                    orderSequence: ["desc", "asc"]
                }
            ];
        }

        // =======================================================================
        // ã€è¯­å½•å®šæ—¶æ›´æ–°åŠŸèƒ½ã€‘æ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡è¯­å½•
        // =======================================================================
        function setupQuoteUpdate() {
            function updateQuote() {
                console.log('ğŸ“ æ›´æ–°è¯­å½•...');
                loadRandomQuote();
                showRefreshStatus('è¯­å½•å·²æ›´æ–°');
            }
            
            // ç«‹å³æ˜¾ç¤ºä¸€æ¡è¯­å½•
            loadRandomQuote();
            
            // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡è¯­å½•
            setInterval(updateQuote, QUOTE_UPDATE_INTERVAL);
            
            console.log(`ğŸ“ è¯­å½•å®šæ—¶æ›´æ–°å·²å¯åŠ¨ï¼Œæ¯ ${QUOTE_UPDATE_INTERVAL/1000/60} åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡`);
        }

        // =======================================================================
        // ã€ä¿®æ­£åçš„å®šæ—¶åˆ·æ–°åŠŸèƒ½ã€‘æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œåœ¨ 10:00-15:00 ä¹‹é—´æ¯10åˆ†é’Ÿåˆ·æ–°é¡µé¢
        // =======================================================================
        function setupConditionalRefresh() {
            // é¡µé¢åŠ è½½æ—¶ï¼Œåˆå§‹åŒ– lastRefreshTime ä¸ºå½“å‰æ—¶é—´ï¼Œç¡®ä¿ç¬¬ä¸€æ¬¡æ£€æŸ¥åä¸ä¼šç«‹å³åˆ·æ–°
            lastRefreshTime = Date.now();
            console.log(`ğŸ”„ é¦–æ¬¡åŠ è½½æ—¶é—´å·²è®°å½•: ${new Date(lastRefreshTime).toLocaleTimeString()}`);


            function checkTimeAndRefresh() {
                const now = new Date();
                const hour = now.getHours();
                const currentTime = now.getTime();
                
                // 1. æ£€æŸ¥æ˜¯å¦åœ¨åˆ·æ–°æ—¶æ®µå†… (10:00 åˆ° 14:59:59)
                const inRefreshWindow = (hour >= 10 && hour < 15);
                
                // 2. æ£€æŸ¥è·ç¦»ä¸Šæ¬¡åˆ·æ–°çš„æ—¶é—´æ˜¯å¦å·²è¶…è¿‡ REFRESH_INTERVAL (10åˆ†é’Ÿ)
                const timeElapsed = currentTime - lastRefreshTime;
                const shouldRefresh = timeElapsed >= REFRESH_INTERVAL;


                if (inRefreshWindow && shouldRefresh) {
                    console.log(`âœ… ${now.toLocaleTimeString()} - åœ¨åˆ·æ–°æ—¶æ®µå†…ä¸”è¶…è¿‡ ${REFRESH_INTERVAL/1000/60} åˆ†é’Ÿï¼Œè‡ªåŠ¨åˆ·æ–°...`);
                    showRefreshStatus('æ­£åœ¨è‡ªåŠ¨åˆ·æ–°é¡µé¢...');
                    
                    // æ‰§è¡Œé¡µé¢åˆ·æ–°
                    location.reload(); 
                    
                    // æ³¨æ„ï¼šlocation.reload() åï¼Œä¸‹é¢çš„ä»£ç ä¸ä¼šæ‰§è¡Œï¼Œ
                    // æ–°åŠ è½½çš„é¡µé¢ä¼šé‡æ–°åˆå§‹åŒ– lastRefreshTime å¹¶å¯åŠ¨å¾ªç¯ã€‚
                    
                } else if (inRefreshWindow) {
                     const timeRemaining = REFRESH_INTERVAL - timeElapsed;
                     const minutesRemaining = Math.ceil(timeRemaining / 60000);
                     console.log(`ğŸ•’ ${now.toLocaleTimeString()} - åœ¨åˆ·æ–°æ—¶æ®µå†…ï¼Œè·ä¸‹æ¬¡åˆ·æ–°è¿˜å‰©çº¦ ${minutesRemaining} åˆ†é’Ÿã€‚`);
                     showRefreshStatus(`åˆ·æ–°æ—¶æ®µå†…ï¼Œè·ä¸‹æ¬¡åˆ·æ–°è¿˜å‰©çº¦ ${minutesRemaining} åˆ†é’Ÿ`);
                } 
                else {
                    console.log(`â¸ï¸ ${now.toLocaleTimeString()} - éåˆ·æ–°æ—¶æ®µï¼Œç­‰å¾…ä¸‹æ¬¡æ£€æŸ¥...`);
                }
            }
            
            // è®¾ç½®ä¸€ä¸ªæ¯åˆ†é’Ÿè¿è¡Œä¸€æ¬¡çš„ setInterval æŒç»­æ£€æŸ¥æ—¶é—´
            // è¿™æ ·æ— è®ºç”¨æˆ·åœ¨å“ªä¸ªæ—¶æ®µæ‰“å¼€é¡µé¢ï¼Œæ£€æŸ¥éƒ½ä¼šå‘¨æœŸæ€§åœ°è¿è¡Œã€‚
            setInterval(checkTimeAndRefresh, BASE_CHECK_INTERVAL);
            
            console.log(`ğŸ”„ å®šæ—¶åˆ·æ–°æ£€æŸ¥å·²å¯åŠ¨ï¼Œæ¯ ${BASE_CHECK_INTERVAL/1000/60} åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡`);
            
            // é¡µé¢åŠ è½½åç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
            checkTimeAndRefresh(); 
        }

        // é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨ä¸»å‡½æ•°å’Œè¯­å½•åŠ è½½å‡½æ•°
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplayData(); 
            setupQuoteUpdate(); // å¯åŠ¨è¯­å½•å®šæ—¶æ›´æ–°
            setupConditionalRefresh(); // å¯åŠ¨å®šæ—¶åˆ·æ–°æ£€æŸ¥ (ä¿®æ­£åçš„ç‰ˆæœ¬)
        });

    </script>
</body>
</html>
