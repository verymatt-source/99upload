<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- é˜²æ­¢æ ‡ç­¾é¡µä¼‘çœ ï¼šé¡µé¢è‡ªåŠ¨åˆ·æ–° -->
    <meta http-equiv="refresh" content="1200">
    
    <title>Munger</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="quotes.js"></script>
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; color: #333; }
        h1 { color: #1e88e5; margin-bottom: 20px; }
        

        
        /* è¯­å½•æ¡†æ ·å¼ */
        .quote-container { 
            background-color: #fff9c4; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            padding: 15px 20px; 
            margin: 0 auto 20px auto; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            max-width: 40%; 
        }
        .quote-text { font-size: 18px; font-style: italic; color: #856404; margin-bottom: 5px; line-height: 1.5; }
        .quote-author { font-size: 14px; text-align: right; font-weight: bold; color: #b83838; }
        
        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        table.dataTable thead th {
            background-color: #2196F3;
            color: white;
            font-weight: bold;
            text-align: center;
            border-bottom: 2px solid #1976D2;
            /* ã€æ–°å¢ã€‘å­—æ®µé—´å‚ç›´åˆ†éš”çº¿ */
            border-right: 2px solid rgba(255, 255, 255, 0.3); 
        }
        /* ã€æ–°å¢ã€‘ç§»é™¤æœ€åä¸€åˆ—çš„å³ä¾§è¾¹æ¡†ï¼Œä½¿å¤–è§‚æ›´æ•´æ´ */
        table.dataTable thead th:last-child {
            border-right: none;
        }
        
        table.dataTable tbody td {
            vertical-align: middle;
        }
        
        /* åˆ·æ–°çŠ¶æ€æç¤ºæ ·å¼ */
        .refresh-status {
            position: fixed; top: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.8); color: white;
            padding: 8px 12px; border-radius: 4px; font-size: 12px;
            z-index: 1000; display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    
    <div class="quote-container">
        <div id="quote-text" class="quote-text">æ­£åœ¨åŠ è½½è¯­å½•...</div>
        <div id="quote-author" class="quote-author"></div>
    </div>

    <h1>ğŸ“ Munger è¡¨æ ¼æ•°æ® (åªè¯»)</h1>
    
    <div id="refresh-status" class="refresh-status"></div>

    <div id="data-container">
        <table id="munger-table" class="display" style="width:100%">
            </table>
    </div>
    
    <br><br>
    
    <h1>ğŸ“Š æŒ‡æ•°PEæ•°æ® (åªè¯»)</h1>
    
    <div id="pe-data-container">
        <table id="pe-table" class="display" style="width:100%">
            </table>
    </div>
    
    <script>
        // =======================================================================
        // ã€é…ç½®ä¿¡æ¯ã€‘
        // =======================================================================
        const CONFIG = {
            SUPABASE_URL: 'https://qburustwmcjpnilofjsi.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFidXJ1c3R3bWNqcG5pbG9manNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MTI4MjUsImV4cCI6MjA3OTM4ODgyNX0.mzJN1k0ogNnr9kpqtandH_OH9nHIIeNrde1uac4JEdc',
            TABLE_NAME: 'Munger',
            PE_TABLE_NAME: 'all_indexes_PE',
            QUOTE_INTERVAL: 300000,    // 5åˆ†é’Ÿæ›´æ–°è¯­å½•
        };
        
        const client = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        
        const els = {
            quoteText: document.getElementById('quote-text'),
            quoteAuthor: document.getElementById('quote-author'),
            refreshStatus: document.getElementById('refresh-status')
        };
        
        let dataTableInstance = null;
        let peDataTableInstance = null;
        
        // ç¼“å­˜è¡¨æ ¼é…ç½®å¯¹è±¡
        let mungerTableConfig = null;
        let peTableConfig = null;

        // -----------------------------------------------------------------------
        // æ ¸å¿ƒé€»è¾‘ï¼šè·å–æ•°æ® (SPAæ¨¡å¼)
        // -----------------------------------------------------------------------
        async function fetchData() {
            showRefreshStatus('æ­£åœ¨åŒæ­¥æœ€æ–°æ•°æ®...');
            
            try {
                // è·å– Munger æ•°æ®
                const { data: mungerData, error: mungerError } = await client
                    .from(CONFIG.TABLE_NAME)
                    .select('*')
                    .order('ratio', { ascending: true });

                if (mungerError) throw mungerError;

                // è·å– PE æ•°æ®
                const { data: peData, error: peError } = await client
                    .from(CONFIG.PE_TABLE_NAME)
                    .select('*')
                    .order('å¹³å‡æ”¶ç›Šç‡', { ascending: false });

                if (peError) throw peError;

                if ((!mungerData || mungerData.length === 0) && (!peData || peData.length === 0)) {
                    showRefreshStatus('æ•°æ®åº“ä¸ºç©º', true);
                    return;
                }

                updateTable(mungerData);
                updatePETable(peData);
                showRefreshStatus('æ•°æ®å·²æ›´æ–°');
                
            } catch (e) {
                console.error('Data Fetch Error:', e);
                console.error('Error details:', {
                    message: e.message,
                    status: e.status,
                    details: e.details,
                    hint: e.hint
                });
                showRefreshStatus(`æ•°æ®æ›´æ–°å¤±è´¥: ${e.message || 'æœªçŸ¥é”™è¯¯'}`, true);
            }
        }

        // -----------------------------------------------------------------------
        // è¡¨æ ¼æ›´æ–°é€»è¾‘
        // -----------------------------------------------------------------------
        function updateTable(data) {
            if (!dataTableInstance) {
                // åˆ›å»ºå¹¶ç¼“å­˜é…ç½®
                mungerTableConfig = {
                    hiddenFields: ['id', 'created_at', 'frequency'],
                    numFields: ['target_price', 'current_price'],
                    percentFields: ['ratio'],
                    timeFields: ['updated_at'],
                    specialFields: [{
                        field: 'ratio',
                        format: createColorFormat(10, '#4caf50', '#555')
                    }]
                };
                
                // åŠ¨æ€è®¡ç®— ratio åˆ—ç´¢å¼•
                const visibleColumns = Object.keys(data[0] || {}).filter(key => !mungerTableConfig.hiddenFields.includes(key));
                mungerTableConfig.order = [[visibleColumns.indexOf('ratio'), 'asc']];
                
                dataTableInstance = initTable('munger-table', data, mungerTableConfig);
            } else {
                // ä½¿ç”¨ç¼“å­˜çš„é…ç½®
                const processedData = preprocessTableData(data, mungerTableConfig);
                dataTableInstance.clear().rows.add(processedData).draw(false);
            }
        }

        function updatePETable(data) {
            if (!peDataTableInstance) {
                // åˆ›å»ºå¹¶ç¼“å­˜é…ç½®
                peTableConfig = {
                    hiddenFields: ['id', 'created_at', 'èƒœç‡_Numeric', 'å¹³å‡æ”¶ç›Šç‡_Numeric'],
                    numFields: [],
                    percentFields: ['å½“å‰æŒ‡æ•°ç™¾åˆ†ä½', 'å½“å‰PEç™¾åˆ†ä½', 'å¹³å‡æŒ‡æ•°ç‚¹ä½ç™¾åˆ†ä½', 'èƒœç‡', 'å¹³å‡æ”¶ç›Šç‡', 'ä¹°å…¥åˆ†ä½æ•°'],
                    timeFields: ['æ›´æ–°æ—¶é—´'],
                    specialFields: [{
                        field: 'å½“å‰PEç™¾åˆ†ä½',
                        format: createColorFormat(20, '#4caf50', '#555')
                    }]
                };
                
                peDataTableInstance = initTable('pe-table', data, peTableConfig);
            } else {
                // ä½¿ç”¨ç¼“å­˜çš„é…ç½®
                const processedData = preprocessTableData(data, peTableConfig);
                peDataTableInstance.clear().rows.add(processedData).draw(false);
            }
        }

        function initTable(tableId, data, config) {
            // ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®é¢„å¤„ç†å‡½æ•°
            const processedData = preprocessTableData(data, config);
            
            // ç”Ÿæˆåˆ—å®šä¹‰
            const columns = Object.keys(processedData[0] || {})
                .filter(key => !config.hiddenFields.includes(key))
                .map(key => ({ data: key, title: key }));
            
            // åˆ›å»ºè¡¨æ ¼å®ä¾‹
            const tableInstance = $(`#${tableId}`).DataTable({
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/zh.json' },
                data: processedData,
                columns: columns,
                order: config.order,
                searching: false,
                paging: false,
                info: true,
                responsive: true,
                createdRow: function(row, data, dataIndex) {
                    $(row).addClass('fade-in');
                }
            });
            
            return tableInstance;
        }


        // -----------------------------------------------------------------------
        // å·¥å…·å‡½æ•°
        // -----------------------------------------------------------------------
        
        // ç»Ÿä¸€ç™¾åˆ†æ¯”æ ¼å¼åŒ–å‡½æ•°
        function formatPercent(value) {
            const val = parseFloat(value);
            if (!isNaN(val) && isFinite(val)) {
                return  (val * 100).toFixed(2) + '%';
            }
            return value;
        }
        
        // æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return dateTimeStr;
            return dateTimeStr.replace('T', ' ').replace('+00:00', '').replace(/\.\d+/, '').replace(' 00:00:00','');
        }
        
        // é¢œè‰²æ ¼å¼åŒ–ç”Ÿæˆå‡½æ•°
        function createColorFormat(threshold, color = '#4caf50', defaultColor = '#555') {
            return (value) => {
                const numValue = parseFloat(value);
                const finalColor = numValue <= threshold ? color : defaultColor;
                return `<span style="color:${finalColor}; font-weight:bold;">${value}</span>`;
            };
        }
        
        // æ•°æ®é¢„å¤„ç†å‡½æ•°
        function preprocessTableData(data, config) {
            return data.map(row => {
                const processedRow = { ...row };
                
                // æ•°å­—æ ¼å¼åŒ–
                if (config.numFields) {
                    config.numFields.forEach(field => {
                        if (processedRow[field] !== null && processedRow[field] !== undefined) {
                            processedRow[field] = parseFloat(processedRow[field]).toFixed(2);
                        }
                    });
                }
                
                // ç™¾åˆ†æ¯”æ ¼å¼åŒ–ï¼ˆä½¿ç”¨ç»Ÿä¸€å‡½æ•°ï¼‰
                if (config.percentFields) {
                    config.percentFields.forEach(field => {
                        if (processedRow[field] !== null && processedRow[field] !== undefined) {
                            processedRow[field] = formatPercent(processedRow[field]);
                        }
                    });
                }
                
                // ç‰¹æ®Šå­—æ®µå¤„ç†
                if (config.specialFields) {
                    config.specialFields.forEach(special => {
                        if (processedRow[special.field] !== null && processedRow[special.field] !== undefined) {
                            processedRow[special.field] = special.format(processedRow[special.field]);
                        }
                    });
                }
                
                // æ—¶é—´æ ¼å¼åŒ–ï¼ˆä½¿ç”¨ç»Ÿä¸€å‡½æ•°ï¼‰
                if (config.timeFields) {
                    config.timeFields.forEach(field => {
                        if (processedRow[field]) {
                            processedRow[field] = formatDateTime(processedRow[field]);
                        }
                    });
                }
                
                return processedRow;
            });
        }

        // -----------------------------------------------------------------------
        // è¾…åŠ©å‡½æ•°
        // -----------------------------------------------------------------------
        
        function loadRandomQuote() {
            if (!window.quotesData || !Array.isArray(window.quotesData)) {
                els.quoteText.textContent = 'Data Not Found';
                return;
            }
            const item = window.quotesData[Math.floor(Math.random() * window.quotesData.length)];
            els.quoteText.textContent = item.quote;
            els.quoteAuthor.textContent = item.author ? `- ${item.author}` : '';
        }

        function showRefreshStatus(msg, isError = false) {
            els.refreshStatus.textContent = msg;
            els.refreshStatus.style.display = 'block';
            els.refreshStatus.style.background = isError ? 'rgba(229, 57, 53, 0.9)' : 'rgba(0, 0, 0, 0.7)';
            setTimeout(() => els.refreshStatus.style.display = 'none', 3000);
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®ï¼Œåç»­ç”±meta refreshæ§åˆ¶
        fetchData();
        
        // åˆå§‹åŠ è½½
        loadRandomQuote();
        setInterval(loadRandomQuote, CONFIG.QUOTE_INTERVAL);

    </script>
</body>
</html>
